pipeline {
    agent any
    
    environment {
        PROJECT_ID='peak-axiom-426310-b1'
        CLIENT_EMAIL='jenkins-vm-controller@peak-axiom-426310-b1.iam.gserviceaccount.com'
        GCLOUD_CREDS=credentials('GCP-service-key')
        CLUSTER_NAME = 'autopilot-cluster-1'
        CLUSTER_ZONE = 'us-west1'
      }
stages{
  stage('Validate Image Existence') {
        steps {
                script {
                    def image = 'us-central1-docker.pkg.dev/peak-axiom-426310-b1/docker-image-push-01/helloworld1'
                    def result = sh(returnStdout: true, script: "gcloud container images list-tags ${image}")
 
                    if (result.trim() != "") {
                        echo "Image ${image} exists in GCR!"
                    } else {
                        error "Image ${image} does not exist in GCR."
                    }
                }
            }
       } 
     stage('Login to GCP') {
         steps {
        script {
                 sh 'gcloud auth activate-service-account --key-file="$GCLOUD_CREDS" ' 
                 sh 'gcloud config set project $PROJECT_ID'
                 sh 'gcloud config set compute/zone $CLUSTER_ZONE'
            }
        }
       }
    stage('Cluster Login') {
        steps {
        script {
               sh'gcloud container clusters get-credentials $CLUSTER_NAME'
            }
        }
       }
   stage('Create Namespace') {
         steps {
                script {
                sh 'kubectl create namespace my-namespace'
            }
       }
    }

    stage('Deploy to GKE') {
            steps {
                script {
                        sh 'kubectl apply -f deployment.yaml'
                }
            }
        }
}
     post {
            always {
                 cleanWs()
            }
        }  
}
